{% extends "base.html" %}

{% block title %}Gerenciar Filas{% endblock %}

{% block content %}
<style>
    /* Estilos consistentes com as outras páginas */
    .layout-split { display: flex; gap: 30px; }
    .sidebar { flex: 0 0 250px; border-right: 1px solid #e0e0e0; padding-right: 20px; }
    .sidebar h3 { margin-top: 0; color: #0056b3; }
    .item-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
    .item-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .item-list li:hover { background-color: #f4f8fb; }
    .item-list li.selected { background-color: #e0eafc; font-weight: bold; color: #0056b3; }
    .main-content { flex-grow: 1; }
    .main-content h2 { margin-top: 0; }
    .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
    .form-group { flex: 1; display: flex; flex-direction: column; }
    .form-group label { font-weight: bold; margin-bottom: 5px; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .form-group input:read-only { background-color: #f0f0f0; cursor: not-allowed; }
    .form-actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    .form-actions button { padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
    .btn-save { background-color: #28a745; color: white; }
    .btn-new { background-color: #007bff; color: white; }
    .btn-delete { background-color: #dc3545; color: white; margin-left: auto; }
    .btn-delete:disabled { background-color: #ccc; cursor: not-allowed; }
    
    /* CORREÇÃO DO CHECKBOX */
    .ramais-checkbox-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px; }
    .ramal-checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 0;
        cursor: pointer; /* Faz a linha inteira ser clicável */
    }
    .ramal-checkbox-item input {
        width: auto;
        flex-shrink: 0;
        cursor: pointer; /* Garante que o checkbox tenha o cursor de ponteiro */
    }
</style>

<div class="card layout-split">

    <!-- Sidebar: lista de filas -->
    <aside class="sidebar">
        <h3>Filas</h3>
        {% if filas %}
            <ul class="item-list" id="fila-list">
                {% for f in filas %}
                    <li onclick="selectFila(this, '{{ f.id }}', '{{ f.fila }}', '{{ f.nome }}', {{ f.ramais | tojson }})">
                        <span>{{ f.fila }} - {{ f.nome }}</span>
                        <span>&rsaquo;</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhuma fila cadastrada.</p>
        {% endif %}
    </aside>

    <!-- Formulário principal -->
    <main class="main-content">
        <h2 id="form-title">Nova Fila</h2>

        <form method="POST" id="form-fila" action="{{ url_for('pabx.cadastro_fila') }}">
            <input type="hidden" name="id" id="fila-id">

            <div class="form-row">
                <div class="form-group" style="flex-basis: 120px; flex-grow: 0;">
                    <label for="fila">Número Fila:</label>
                    <input type="number" name="fila" id="fila" required>
                </div>
                <div class="form-group">
                    <label for="nome">Nome da Fila:</label>
                    <input type="text" name="nome" id="nome" required>
                </div>
            </div>

            <div class="form-group">
                <label>Ramais na Fila:</label>
                <div class="ramais-checkbox-list">
                    {% for r in ramais %}
                        <!-- CORREÇÃO DA ESTRUTURA HTML DO CHECKBOX -->
                        <label class="ramal-checkbox-item" for="ramal-{{ r.id }}">
                            <input type="checkbox" name="ramais" value="{{ r.id }}" id="ramal-{{ r.id }}">
                            <span>{{ r.ramal }} - {{ r.nome }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-save">&#128190; Salvar</button>
                <button type="button" class="btn-new" onclick="resetForm()">&#43; Nova Fila</button>
                <button type="button" class="btn-delete" id="btn-delete" onclick="excluirFila()" disabled>&#128465; Excluir</button>
            </div>
        </form>
    </main>
</div>

<script>
let currentSelectedLi = null;

function selectFila(element, id, numero, nome, ramaisAssociados) {
    if (currentSelectedLi) {
        currentSelectedLi.classList.remove('selected');
    }
    element.classList.add('selected');
    currentSelectedLi = element;

    document.getElementById('fila-id').value = id;
    const filaInput = document.getElementById('fila');
    filaInput.value = numero;
    filaInput.readOnly = true;
    document.getElementById('nome').value = nome;

    // Marca os checkboxes dos ramais associados
    document.querySelectorAll('input[name="ramais"]').forEach(checkbox => {
        // CORREÇÃO: Garantir que ambos os lados da comparação são números
        checkbox.checked = ramaisAssociados.includes(parseInt(checkbox.value, 10));
    });

    document.getElementById('form-title').innerText = "Editar Fila " + numero;
    document.getElementById('btn-delete').disabled = false;
}

function resetForm() {
    if (currentSelectedLi) {
        currentSelectedLi.classList.remove('selected');
        currentSelectedLi = null;
    }
    document.getElementById('form-fila').reset();
    document.getElementById('fila-id').value = '';
    document.getElementById('fila').readOnly = false;
    document.getElementById('form-title').innerText = "Nova Fila";
    document.getElementById('btn-delete').disabled = true;
}

function excluirFila() {
    const filaId = document.getElementById("fila-id").value;
    if (!filaId) {
        alert("Selecione uma fila da lista para excluir.");
        return;
    }
    if (confirm('Tem certeza que deseja excluir esta fila?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('pabx.excluir_fila') }}";
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'id';
        input.value = filaId;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

document.addEventListener('DOMContentLoaded', resetForm);
</script>
{% endblock %}

